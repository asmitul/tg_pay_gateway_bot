name: Production Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  LOG_LEVEL: ${{ vars.LOG_LEVEL || 'info' }}
  MONGO_DB: ${{ vars.MONGO_DB || github.event.repository.name }}
  APP_ENV: production

jobs:
  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: read

    steps:
      - name: Deploy container
        uses: appleboy/ssh-action@v1.0.0
        env:
          IMAGE_TAG: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
          CONTAINER_NAME: ${{ github.event.repository.name }}
          APP_ENV: ${{ env.APP_ENV }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          BOT_OWNER: ${{ secrets.BOT_OWNER }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB: ${{ env.MONGO_DB }}
          LOG_LEVEL: ${{ env.LOG_LEVEL }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: IMAGE_TAG,CONTAINER_NAME,APP_ENV,TELEGRAM_TOKEN,BOT_OWNER,MONGO_URI,MONGO_DB,LOG_LEVEL,GITHUB_ACTOR,GITHUB_TOKEN
          script: |
            set -eo pipefail

            echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin
            docker pull "${IMAGE_TAG}"

            if docker ps -a --format '{{.Names}}' | grep -w "${CONTAINER_NAME}-old" >/dev/null; then
              docker rm -f "${CONTAINER_NAME}-old"
            fi

            if docker ps -a --format '{{.Names}}' | grep -w "${CONTAINER_NAME}" >/dev/null; then
              docker stop "${CONTAINER_NAME}" || true
              docker rename "${CONTAINER_NAME}" "${CONTAINER_NAME}-old" || true
            fi

            LOG_OPT=""
            if [ -n "${LOG_LEVEL}" ] && [ "${LOG_LEVEL}" != "info" ]; then
              LOG_OPT="-e LOG_LEVEL=${LOG_LEVEL}"
            fi

            docker run -d \
              --name "${CONTAINER_NAME}" \
              --restart unless-stopped \
              --network bridge \
              -e APP_ENV="${APP_ENV}" \
              -e TELEGRAM_TOKEN="${TELEGRAM_TOKEN}" \
              -e BOT_OWNER="${BOT_OWNER}" \
              -e MONGO_URI="${MONGO_URI}" \
              -e MONGO_DB="${MONGO_DB}" \
              ${LOG_OPT} \
              --log-driver json-file \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              "${IMAGE_TAG}"

            sleep 10

            if docker ps --format '{{.Names}}' | grep -w "${CONTAINER_NAME}" >/dev/null; then
              echo "Container started; cleaning up old release."
              if docker ps -a --format '{{.Names}}' | grep -w "${CONTAINER_NAME}-old" >/dev/null; then
                docker rm -f "${CONTAINER_NAME}-old"
              fi
            else
              echo "Container failed to start; rolling back."
              docker logs --tail=100 "${CONTAINER_NAME}" || true
              docker rm -f "${CONTAINER_NAME}" || true
              if docker ps -a --format '{{.Names}}' | grep -w "${CONTAINER_NAME}-old" >/dev/null; then
                docker rename "${CONTAINER_NAME}-old" "${CONTAINER_NAME}"
                docker start "${CONTAINER_NAME}"
              fi
              exit 1
            fi

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        env:
          CONTAINER_NAME: ${{ github.event.repository.name }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: CONTAINER_NAME
          script: |
            if docker ps --format '{{.Names}}' | grep -w "${CONTAINER_NAME}" >/dev/null; then
              echo "Deployment is healthy."
            else
              echo "Deployment is not running."
              docker logs --tail=100 "${CONTAINER_NAME}" || true
              exit 1
            fi
